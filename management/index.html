<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Management - Beregovskiy Portfolio</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Content Management</h1>
            <nav class="admin-nav">
                <a href="index.html" class="active">Content</a>
                <a href="categories.html">Categories</a>
                <a href="profile.html">Profile</a>
                <a href="../index.html" class="home-link">‚Üê Back to Portfolio</a>
            </nav>
        </header>

        <main class="admin-main">
            <section class="admin-section">
                <h2>Add New Content</h2>
                
                <form id="contentForm" class="admin-form">
                    <div class="form-group">
                        <label for="contentType">Content Type *</label>
                        <select id="contentType" required>
                            <option value="">Select type...</option>
                            <option value="article">Article</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" required>
                            <option value="">Loading categories...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="subcategory">Subcategory (optional)</label>
                        <select id="subcategory">
                            <option value="">No subcategory</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" required placeholder="Enter content title">
                    </div>

                    <div class="form-group">
                        <label for="subtitle">Subtitle</label>
                        <input type="text" id="subtitle" placeholder="Enter subtitle (optional)">
                    </div>

                    <div class="form-group" id="contentGroup">
                        <label for="content">Content</label>
                        <textarea id="content" rows="10" placeholder="Enter your content here..."></textarea>
                    </div>

                    <div class="form-group" id="imageUrlGroup" style="display: none;">
                        <label for="imageUrl">Image URL</label>
                        <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="form-group" id="videoUrlGroup" style="display: none;">
                        <label for="videoUrl">Video URL</label>
                        <input type="url" id="videoUrl" placeholder="https://youtube.com/watch?v=...">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="submitBtn">Add Content</button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">Clear Form</button>
                    </div>
                </form>

                <div id="statusMessage" class="status-message" style="display: none;"></div>
            </section>

            <section class="admin-section">
                <h2>Existing Content</h2>
                <div id="contentList" class="content-list">
                    <p class="loading">Loading content...</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../content.js"></script>
    
    <script>
        let editingContentId = null;
        let allCategories = [];

        // Show/hide fields based on content type
        document.getElementById('contentType').addEventListener('change', function() {
            const type = this.value;
            const contentGroup = document.getElementById('contentGroup');
            const imageGroup = document.getElementById('imageUrlGroup');
            const videoGroup = document.getElementById('videoUrlGroup');

            // Reset visibility
            contentGroup.style.display = 'block';
            imageGroup.style.display = 'none';
            videoGroup.style.display = 'none';

            // Show relevant fields
            if (type === 'image') {
                imageGroup.style.display = 'block';
            } else if (type === 'video') {
                videoGroup.style.display = 'block';
            }

            // Filter categories by type
            loadCategoriesByType(type);
        });

        // Load subcategories when category changes
        document.getElementById('category').addEventListener('change', function() {
            loadSubcategories(this.value);
        });

        // Load categories by type
        async function loadCategoriesByType(type) {
            const categorySelect = document.getElementById('category');
            const categories = allCategories.filter(cat => cat.type === type + 's');
            
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                categorySelect.appendChild(option);
            });

            // Clear subcategories
            document.getElementById('subcategory').innerHTML = '<option value="">No subcategory</option>';
        }

        // Load subcategories for selected category
        function loadSubcategories(categoryId) {
            const subcategorySelect = document.getElementById('subcategory');
            subcategorySelect.innerHTML = '<option value="">No subcategory</option>';

            if (!categoryId) return;

            const category = allCategories.find(cat => cat.id === categoryId);
            if (category && category.subcategories) {
                category.subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.id;
                    option.textContent = sub.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // Load all categories
        async function loadAllCategories() {
            try {
                allCategories = await getCategories();
            } catch (error) {
                console.error('Error loading categories:', error);
                showStatus('Error loading categories', 'error');
            }
        }

        // Submit form
        document.getElementById('contentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = editingContentId ? 'Updating...' : 'Adding...';

            const contentData = {
                type: document.getElementById('contentType').value,
                categoryId: document.getElementById('category').value,
                subcategoryId: document.getElementById('subcategory').value || null,
                title: document.getElementById('title').value,
                subtitle: document.getElementById('subtitle').value,
                content: document.getElementById('content').value,
                imageUrl: document.getElementById('imageUrl').value,
                videoUrl: document.getElementById('videoUrl').value
            };

            try {
                if (editingContentId) {
                    await updateContent(editingContentId, contentData);
                    showStatus('Content updated successfully!', 'success');
                    editingContentId = null;
                } else {
                    await addContent(contentData);
                    showStatus('Content added successfully!', 'success');
                }

                resetForm();
                loadContentList();
            } catch (error) {
                console.error('Error saving content:', error);
                showStatus('Error saving content: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Content';
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('contentForm').reset();
            editingContentId = null;
            document.getElementById('submitBtn').textContent = 'Add Content';
            document.getElementById('contentGroup').style.display = 'block';
            document.getElementById('imageUrlGroup').style.display = 'none';
            document.getElementById('videoUrlGroup').style.display = 'none';
        }

        // Load content list
        async function loadContentList() {
            const contentList = document.getElementById('contentList');
            contentList.innerHTML = '<p class="loading">Loading content...</p>';

            try {
                const content = await getAllContent();
                
                if (content.length === 0) {
                    contentList.innerHTML = '<p class="empty-state">No content yet. Add your first item above!</p>';
                    return;
                }

                contentList.innerHTML = '';
                content.forEach(item => {
                    const contentCard = document.createElement('div');
                    contentCard.className = 'content-card';
                    contentCard.innerHTML = `
                        <div class="content-card-header">
                            <h3>${item.title}</h3>
                            <span class="content-type-badge">${item.type}</span>
                        </div>
                        ${item.subtitle ? `<p class="content-subtitle">${item.subtitle}</p>` : ''}
                        <div class="content-card-actions">
                            <button onclick="editContent('${item.id}')" class="btn-small btn-edit">Edit</button>
                            <button onclick="deleteContentItem('${item.id}')" class="btn-small btn-delete">Delete</button>
                        </div>
                    `;
                    contentList.appendChild(contentCard);
                });
            } catch (error) {
                console.error('Error loading content:', error);
                contentList.innerHTML = '<p class="error">Error loading content</p>';
            }
        }

        // Edit content
        async function editContent(contentId) {
            try {
                const allContent = await getAllContent();
                const content = allContent.find(c => c.id === contentId);
                
                if (!content) {
                    showStatus('Content not found', 'error');
                    return;
                }

                editingContentId = contentId;
                document.getElementById('contentType').value = content.type;
                document.getElementById('contentType').dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    document.getElementById('category').value = content.categoryId;
                    document.getElementById('category').dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        if (content.subcategoryId) {
                            document.getElementById('subcategory').value = content.subcategoryId;
                        }
                    }, 100);
                }, 100);

                document.getElementById('title').value = content.title;
                document.getElementById('subtitle').value = content.subtitle || '';
                document.getElementById('content').value = content.content || '';
                document.getElementById('imageUrl').value = content.imageUrl || '';
                document.getElementById('videoUrl').value = content.videoUrl || '';
                
                document.getElementById('submitBtn').textContent = 'Update Content';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading content for editing:', error);
                showStatus('Error loading content', 'error');
            }
        }

        // Delete content
        async function deleteContentItem(contentId) {
            if (!confirm('Are you sure you want to delete this content?')) {
                return;
            }

            try {
                await deleteContent(contentId);
                showStatus('Content deleted successfully', 'success');
                loadContentList();
            } catch (error) {
                console.error('Error deleting content:', error);
                showStatus('Error deleting content', 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllCategories();
            await loadContentList();
        });
    </script>
</body>
</html>