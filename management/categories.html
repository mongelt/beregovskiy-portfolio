<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management - Beregovskiy Portfolio</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Category Management</h1>
            <nav class="admin-nav">
                <a href="index.html">Content</a>
                <a href="categories.html" class="active">Categories</a>
                <a href="profile.html">Profile</a>
                <a href="../index.html" class="home-link">‚Üê Back to Portfolio</a>
            </nav>
        </header>

        <main class="admin-main">
            <section class="admin-section">
                <h2>Add New Category</h2>
                
                <form id="categoryForm" class="admin-form">
                    <div class="form-group">
                        <label for="categoryName">Category Name *</label>
                        <input type="text" id="categoryName" required placeholder="e.g., News Articles">
                    </div>

                    <div class="form-group">
                        <label for="categoryType">Content Type *</label>
                        <select id="categoryType" required>
                            <option value="">Select type...</option>
                            <option value="articles">Articles</option>
                            <option value="images">Images</option>
                            <option value="videos">Videos</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="categorySubmitBtn">Add Category</button>
                        <button type="button" class="btn-secondary" onclick="resetCategoryForm()">Clear</button>
                    </div>
                </form>

                <div id="categoryStatus" class="status-message" style="display: none;"></div>
            </section>

            <section class="admin-section">
                <h2>Add Subcategory</h2>
                
                <form id="subcategoryForm" class="admin-form">
                    <div class="form-group">
                        <label for="parentCategory">Parent Category *</label>
                        <select id="parentCategory" required>
                            <option value="">Loading categories...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="subcategoryName">Subcategory Name *</label>
                        <input type="text" id="subcategoryName" required placeholder="e.g., Breaking News">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="subcategorySubmitBtn">Add Subcategory</button>
                        <button type="button" class="btn-secondary" onclick="resetSubcategoryForm()">Clear</button>
                    </div>
                </form>

                <div id="subcategoryStatus" class="status-message" style="display: none;"></div>
            </section>

            <section class="admin-section">
                <h2>Existing Categories</h2>
                <div id="categoryList" class="category-list">
                    <p class="loading">Loading categories...</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script src="../content.js"></script>
    
    <script>
        let editingCategoryId = null;
        let editingSubcategoryId = null;

        // Submit category form
        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('categorySubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = editingCategoryId ? 'Updating...' : 'Adding...';

            const categoryData = {
                name: document.getElementById('categoryName').value,
                type: document.getElementById('categoryType').value,
                order: 0
            };

            try {
                if (editingCategoryId) {
                    await updateCategory(editingCategoryId, categoryData);
                    showCategoryStatus('Category updated successfully!', 'success');
                    editingCategoryId = null;
                } else {
                    await addCategory(categoryData);
                    showCategoryStatus('Category added successfully!', 'success');
                }

                resetCategoryForm();
                await loadCategoriesList();
                await loadParentCategorySelect();
            } catch (error) {
                console.error('Error saving category:', error);
                showCategoryStatus('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Category';
            }
        });

        // Submit subcategory form
        document.getElementById('subcategoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('subcategorySubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = editingSubcategoryId ? 'Updating...' : 'Adding...';

            const parentCategoryId = document.getElementById('parentCategory').value;
            const subcategoryData = {
                name: document.getElementById('subcategoryName').value,
                order: 0
            };

            try {
                if (editingSubcategoryId) {
                    await updateSubcategory(editingSubcategoryId, subcategoryData);
                    showSubcategoryStatus('Subcategory updated successfully!', 'success');
                    editingSubcategoryId = null;
                } else {
                    await addSubcategory(parentCategoryId, subcategoryData);
                    showSubcategoryStatus('Subcategory added successfully!', 'success');
                }

                resetSubcategoryForm();
                await loadCategoriesList();
            } catch (error) {
                console.error('Error saving subcategory:', error);
                showSubcategoryStatus('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Subcategory';
            }
        });

        // Reset category form
        function resetCategoryForm() {
            document.getElementById('categoryForm').reset();
            editingCategoryId = null;
            document.getElementById('categorySubmitBtn').textContent = 'Add Category';
        }

        // Reset subcategory form
        function resetSubcategoryForm() {
            document.getElementById('subcategoryForm').reset();
            editingSubcategoryId = null;
            document.getElementById('subcategorySubmitBtn').textContent = 'Add Subcategory';
        }

        // Load parent category select
        async function loadParentCategorySelect() {
            const select = document.getElementById('parentCategory');
            select.innerHTML = '<option value="">Select category...</option>';

            try {
                const categories = await getCategories();
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = `${cat.name} (${cat.type})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                select.innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        // Load categories list
        async function loadCategoriesList() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '<p class="loading">Loading categories...</p>';

            try {
                const categories = await getCategories();
                
                if (categories.length === 0) {
                    categoryList.innerHTML = '<p class="empty-state">No categories yet. Add your first category above!</p>';
                    return;
                }

                categoryList.innerHTML = '';
                categories.forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'category-card';
                    
                    let subcategoriesHtml = '';
                    if (category.subcategories && category.subcategories.length > 0) {
                        subcategoriesHtml = '<div class="subcategories-list">';
                        category.subcategories.forEach(sub => {
                            subcategoriesHtml += `
                                <div class="subcategory-item">
                                    <span>${sub.name}</span>
                                    <div class="subcategory-actions">
                                        <button onclick="editSubcategory('${sub.id}', '${category.id}')" class="btn-tiny">Edit</button>
                                        <button onclick="deleteSubcategoryItem('${sub.id}')" class="btn-tiny btn-delete">Delete</button>
                                    </div>
                                </div>
                            `;
                        });
                        subcategoriesHtml += '</div>';
                    }

                    categoryCard.innerHTML = `
                        <div class="category-card-header">
                            <div>
                                <h3>${category.name}</h3>
                                <span class="category-type-badge">${category.type}</span>
                            </div>
                            <div class="category-card-actions">
                                <button onclick="editCategory('${category.id}')" class="btn-small btn-edit">Edit</button>
                                <button onclick="deleteCategoryItem('${category.id}')" class="btn-small btn-delete">Delete</button>
                            </div>
                        </div>
                        ${subcategoriesHtml}
                    `;
                    categoryList.appendChild(categoryCard);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                categoryList.innerHTML = '<p class="error">Error loading categories</p>';
            }
        }

        // Edit category
        async function editCategory(categoryId) {
            try {
                const categories = await getCategories();
                const category = categories.find(c => c.id === categoryId);
                
                if (!category) {
                    showCategoryStatus('Category not found', 'error');
                    return;
                }

                editingCategoryId = categoryId;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryType').value = category.type;
                document.getElementById('categorySubmitBtn').textContent = 'Update Category';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading category:', error);
                showCategoryStatus('Error loading category', 'error');
            }
        }

        // Delete category
        async function deleteCategoryItem(categoryId) {
            if (!confirm('Are you sure? This will delete the category and ALL its content!')) {
                return;
            }

            try {
                await deleteCategory(categoryId);
                showCategoryStatus('Category deleted successfully', 'success');
                await loadCategoriesList();
                await loadParentCategorySelect();
            } catch (error) {
                console.error('Error deleting category:', error);
                showCategoryStatus('Error deleting category', 'error');
            }
        }

        // Edit subcategory
        async function editSubcategory(subcategoryId, categoryId) {
            try {
                const categories = await getCategories();
                const category = categories.find(c => c.id === categoryId);
                const subcategory = category?.subcategories?.find(s => s.id === subcategoryId);
                
                if (!subcategory) {
                    showSubcategoryStatus('Subcategory not found', 'error');
                    return;
                }

                editingSubcategoryId = subcategoryId;
                document.getElementById('parentCategory').value = categoryId;
                document.getElementById('subcategoryName').value = subcategory.name;
                document.getElementById('subcategorySubmitBtn').textContent = 'Update Subcategory';
                
                document.querySelector('#subcategoryForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading subcategory:', error);
                showSubcategoryStatus('Error loading subcategory', 'error');
            }
        }

        // Delete subcategory
        async function deleteSubcategoryItem(subcategoryId) {
            if (!confirm('Are you sure? This will delete the subcategory and its content!')) {
                return;
            }

            try {
                await deleteSubcategory(subcategoryId);
                showSubcategoryStatus('Subcategory deleted successfully', 'success');
                await loadCategoriesList();
            } catch (error) {
                console.error('Error deleting subcategory:', error);
                showSubcategoryStatus('Error deleting subcategory', 'error');
            }
        }

        // Show status messages
        function showCategoryStatus(message, type) {
            const statusDiv = document.getElementById('categoryStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function showSubcategoryStatus(message, type) {
            const statusDiv = document.getElementById('subcategoryStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadParentCategorySelect();
            await loadCategoriesList();
        });
    </script>
</body>
</html>