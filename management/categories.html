<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management - Portfolio Admin</title>
    <link rel="stylesheet" href="shared-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÅ Category Management</h1>
            <p>Organize your portfolio structure with full editing control</p>
        </div>
        
        <div class="navigation">
            <a href="index.html" class="nav-button">Content Management</a>
            <a href="categories.html" class="nav-button active">Manage Categories</a>
            <a href="profile.html" class="nav-button">Business Card</a>
            <a href="../index.html" class="nav-button secondary">View Website</a>
        </div>
        
        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2>Admin Login</h2>
            <div class="form-group">
                <input type="password" id="passwordInput" placeholder="Enter admin password" style="max-width: 300px; margin: 20px auto;">
            </div>
            <button onclick="login()">Access Category Management</button>
            <p style="margin-top: 20px; color: #666; font-size: 14px;">
                Password: <strong>portfolio2024</strong>
            </p>
        </div>
        
        <!-- Category Management Section -->
        <div class="admin-section" id="adminSection">
            <div style="display: flex; gap: 40px;">
                <!-- Left Column: Add Categories -->
                <div style="flex: 1;">
                    <h2>Add New Category</h2>
                    
                    <div class="form-group">
                        <label for="newCategoryName">Category Name:</label>
                        <input type="text" id="newCategoryName" placeholder="e.g., Writing, Reporting, Media">
                    </div>
                    
                    <div class="form-group">
                        <label for="newSubcategories">Subcategories (one per line):</label>
                        <textarea id="newSubcategories" placeholder="Blog Posts&#10;White Papers&#10;One-Pagers&#10;Press Releases" style="height: 120px;"></textarea>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Type each subcategory on a new line. You can add more later.
                        </small>
                    </div>
                    
                    <button onclick="addNewCategory()">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                    
                    <hr style="margin: 30px 0; border: 1px solid #ddd;">
                    
                    <h2>Add Subcategory</h2>
                    
                    <div class="form-group">
                        <label for="existingCategory">Choose Category:</label>
                        <select id="existingCategory">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newSubcategoryName">New Subcategory Name:</label>
                        <input type="text" id="newSubcategoryName" placeholder="e.g., Press Releases, Feature Stories">
                    </div>
                    
                    <button onclick="addNewSubcategory()">
                        <i class="fas fa-plus"></i> Add Subcategory
                    </button>
                </div>
                
                <!-- Right Column: Current Categories with Management -->
                <div style="flex: 1;">
                    <h2>Current Categories</h2>
                    <div id="categoryList">
                        Loading categories...
                    </div>
                    
                    <button onclick="refreshCategories()" class="secondary" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh List
                    </button>
                </div>
            </div>
            
            <!-- Edit Category Modal-style Section -->
            <div id="editCategorySection" style="display: none; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e74c3c;">
                <h3>Edit Category</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCategoryName">Category Name:</label>
                        <input type="text" id="editCategoryName" placeholder="Category name">
                    </div>
                    <div class="form-group">
                        <label for="editCategoryOrder">Display Order:</label>
                        <input type="number" id="editCategoryOrder" min="1" placeholder="1, 2, 3...">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="saveEditedCategory()" class="update-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button onclick="cancelEditCategory()" class="secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="../content.js"></script>
    <script>
        let editingCategoryName = null;
        
        // Login function
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === 'portfolio2024') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
                loadCategories();
            } else {
                alert('Incorrect password! Try: portfolio2024');
            }
        }
        
        // Load and display current categories with management options
        function loadCategories() {
            const categories = getStoredCategories();
            const categoryList = document.getElementById('categoryList');
            const existingCategorySelect = document.getElementById('existingCategory');
            
            let html = '';
            existingCategorySelect.innerHTML = '<option value="">Select Category</option>';
            
            if (Object.keys(categories).length === 0) {
                html = '<div class="no-categories-management"><h3>No categories yet</h3><p>Create your first category using the form on the left!</p></div>';
            } else {
                Object.keys(categories)
                    .sort((a, b) => categories[a].order - categories[b].order)
                    .forEach(catName => {
                        const category = categories[catName];
                        const subcategoryCount = Object.keys(category.subcategories).length;
                        const contentCount = getContentByCategory(catName).length;
                        
                        // Escape category name for use in onclick
                        const escapedCatName = catName.replace(/'/g, "\\'");
                        
                        html += `
                            <div class="category-management-item">
                                <div class="category-item-header">
                                    <h4>${catName}</h4>
                                    <div class="category-actions">
                                        <button class="edit-btn" onclick="editCategory('${escapedCatName}')" title="Edit Category">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-btn" onclick="deleteCategoryConfirm('${escapedCatName}')" title="Delete Category">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="category-stats">
                                    <span class="stat">${subcategoryCount} subcategories</span>
                                    <span class="stat">${contentCount} items</span>
                                    <span class="stat">Order: ${category.order}</span>
                                </div>
                                
                                <div class="subcategory-list">
                                    ${Object.keys(category.subcategories).length === 0 ? 
                                        '<span style="color: #999; font-style: italic;">No subcategories yet</span>' :
                                        Object.keys(category.subcategories)
                                            .sort((a, b) => category.subcategories[a].order - category.subcategories[b].order)
                                            .map(subName => {
                                                const escapedSubName = subName.replace(/'/g, "\\'");
                                                return `<span class="subcategory-tag">${subName} 
                                                    <button onclick="deleteSubcategoryConfirm('${escapedCatName}', '${escapedSubName}')" 
                                                            style="background:none; border:none; color:#e74c3c; margin-left:5px; cursor:pointer;" 
                                                            title="Delete subcategory">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </span>`;
                                            }).join('')
                                    }
                                </div>
                            </div>
                        `;
                        
                        existingCategorySelect.innerHTML += `<option value="${catName}">${catName}</option>`;
                    });
            }
            
            categoryList.innerHTML = html;
        }
        
        // Delete category with confirmation
        function deleteCategoryConfirm(categoryName) {
            console.log('Delete category called:', categoryName);
            const contentCount = getContentByCategory(categoryName).length;
            
            let confirmationMessage = `Are you sure you want to delete the category "${categoryName}"?`;
            
            if (contentCount > 0) {
                confirmationMessage += `\n\nThis will also delete ${contentCount} content item(s) in this category.`;
            }
            
            confirmationMessage += '\n\nThis action cannot be undone.';
            
            const confirmation = confirm(confirmationMessage);
            if (!confirmation) return;
            
            console.log('Confirmed, deleting category:', categoryName);
            
            // Remove category from storage
            const categories = getStoredCategories();
            delete categories[categoryName];
            saveCategories(categories);
            
            // Remove all content from this category
            if (contentCount > 0) {
                const portfolioContent = getStoredContent();
                
                ['articles', 'images', 'videos'].forEach(type => {
                    portfolioContent[type] = portfolioContent[type].filter(item => 
                        item.category !== categoryName
                    );
                });
                
                saveContent(portfolioContent);
            }
            
            // Refresh displays
            loadCategories();
            showStatusMessage(`Category "${categoryName}" and ${contentCount} items have been deleted.`, 'success');
        }
        
        // Delete subcategory with confirmation
        function deleteSubcategoryConfirm(categoryName, subcategoryName) {
            console.log('Delete subcategory called:', categoryName, subcategoryName);
            const contentCount = getContentByCategory(categoryName, subcategoryName).length;
            
            let confirmationMessage = `Delete subcategory "${subcategoryName}" from "${categoryName}"?`;
            
            if (contentCount > 0) {
                confirmationMessage += `\n\nThis will also delete ${contentCount} content item(s) in this subcategory.`;
            }
            
            const confirmation = confirm(confirmationMessage + '\n\nThis cannot be undone.');
            if (!confirmation) return;
            
            console.log('Confirmed, deleting subcategory');
            
            // Remove subcategory
            const categories = getStoredCategories();
            delete categories[categoryName].subcategories[subcategoryName];
            saveCategories(categories);
            
            // Remove content from this subcategory
            if (contentCount > 0) {
                const portfolioContent = getStoredContent();
                ['articles', 'images', 'videos'].forEach(type => {
                    portfolioContent[type] = portfolioContent[type].filter(item => 
                        !(item.category === categoryName && item.subcategory === subcategoryName)
                    );
                });
                saveContent(portfolioContent);
            }
            
            loadCategories();
            showStatusMessage(`Subcategory "${subcategoryName}" and ${contentCount} items deleted.`, 'success');
        }
        
        // Edit category function
        function editCategory(categoryName) {
            const categories = getStoredCategories();
            const category = categories[categoryName];
            
            if (!category) {
                showStatusMessage('Category not found!', 'error');
                return;
            }
            
            editingCategoryName = categoryName;
            
            // Populate edit form
            document.getElementById('editCategoryName').value = categoryName;
            document.getElementById('editCategoryOrder').value = category.order;
            
            // Show edit section
            document.getElementById('editCategorySection').style.display = 'block';
            
            // Scroll to edit section
            document.getElementById('editCategorySection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Save edited category
        function saveEditedCategory() {
            const newName = document.getElementById('editCategoryName').value.trim();
            const newOrder = parseInt(document.getElementById('editCategoryOrder').value);
            
            if (!newName) {
                showStatusMessage('Please enter a category name.', 'error');
                return;
            }
            
            if (!newOrder || newOrder < 1) {
                showStatusMessage('Please enter a valid order number.', 'error');
                return;
            }
            
            const categories = getStoredCategories();
            
            // Check if new name conflicts with existing category (unless it's the same)
            if (newName !== editingCategoryName && categories[newName]) {
                showStatusMessage('A category with that name already exists!', 'error');
                return;
            }
            
            // Update category
            const categoryData = categories[editingCategoryName];
            
            if (newName !== editingCategoryName) {
                // Rename category - need to update content as well
                delete categories[editingCategoryName];
                categories[newName] = categoryData;
                
                // Update all content with this category
                const portfolioContent = getStoredContent();
                ['articles', 'images', 'videos'].forEach(type => {
                    portfolioContent[type].forEach(item => {
                        if (item.category === editingCategoryName) {
                            item.category = newName;
                        }
                    });
                });
                saveContent(portfolioContent);
            }
            
            categories[newName].order = newOrder;
            saveCategories(categories);
            
            // Hide edit section and refresh
            cancelEditCategory();
            loadCategories();
            showStatusMessage(`Category "${newName}" updated successfully!`, 'success');
        }
        
        // Cancel category editing
        function cancelEditCategory() {
            editingCategoryName = null;
            document.getElementById('editCategorySection').style.display = 'none';
            document.getElementById('editCategoryName').value = '';
            document.getElementById('editCategoryOrder').value = '';
        }
        
        // Add new category with subcategories
        function addNewCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            const subcategoriesText = document.getElementById('newSubcategories').value.trim();
            
            if (!categoryName) {
                showStatusMessage('Please enter a category name.', 'error');
                return;
            }
            
            // Check if category already exists
            const existingCategories = getStoredCategories();
            if (existingCategories[categoryName]) {
                showStatusMessage('Category already exists! Choose a different name.', 'error');
                return;
            }
            
            const subcategories = subcategoriesText ? 
                subcategoriesText.split('\n').map(s => s.trim()).filter(s => s) : [];
            
            addCategory(categoryName, subcategories);
            
            // Clear form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newSubcategories').value = '';
            
            // Refresh display
            loadCategories();
            showStatusMessage(`Category "${categoryName}" added successfully with ${subcategories.length} subcategories!`, 'success');
        }
        
        // Add subcategory to existing category
        function addNewSubcategory() {
            const categoryName = document.getElementById('existingCategory').value;
            const subcategoryName = document.getElementById('newSubcategoryName').value.trim();
            
            if (!categoryName) {
                showStatusMessage('Please select a category.', 'error');
                return;
            }
            
            if (!subcategoryName) {
                showStatusMessage('Please enter a subcategory name.', 'error');
                return;
            }
            
            // Check if subcategory already exists
            const categories = getStoredCategories();
            if (categories[categoryName].subcategories[subcategoryName]) {
                showStatusMessage('Subcategory already exists in this category!', 'error');
                return;
            }
            
            addSubcategory(categoryName, subcategoryName);
            
            // Clear form
            document.getElementById('newSubcategoryName').value = '';
            document.getElementById('existingCategory').value = '';
            
            // Refresh display
            loadCategories();
            showStatusMessage(`Subcategory "${subcategoryName}" added to "${categoryName}"!`, 'success');
        }
        
        // Refresh categories display
        function refreshCategories() {
            loadCategories();
            showStatusMessage('Categories refreshed!', 'success');
        }
        
        // Show status message
        function showStatusMessage(message, type = 'info') {
            // Remove existing messages
            const existing = document.querySelector('.status-message');
            if (existing) existing.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // Enter key to login
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>